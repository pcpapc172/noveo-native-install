name: Sign IPA and Deploy to GitHub Pages

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'Source repository (owner/repo)'
        required: true
        default: 'pcpapc172/NoveoNative'
      release_tag:
        description: 'Release tag (leave empty for latest)'
        required: false
      force_deploy:
        description: 'Force redeploy (skip version check)'
        required: false
        type: boolean
        default: false
  schedule:
    - cron: '0 */6 * * *'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  sign-and-deploy:
    runs-on: macos-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          
      - name: Get latest release info
        id: release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          REPO="${{ github.event.inputs.source_repo || 'pcpapc172/NoveoNative' }}"
          echo "Fetching release from: $REPO"
          
          if [ -z "${{ github.event.inputs.release_tag }}" ]; then
            RELEASE_DATA=$(curl -s -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/repos/$REPO/releases/latest")
          else
            RELEASE_DATA=$(curl -s -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/repos/$REPO/releases/tags/${{ github.event.inputs.release_tag }}")
          fi
          
          TAG_NAME=$(echo "$RELEASE_DATA" | jq -r '.tag_name // empty')
          PUBLISHED_AT=$(echo "$RELEASE_DATA" | jq -r '.published_at // empty')
          IPA_URL=$(echo "$RELEASE_DATA" | jq -r '.assets[]? | select(.name | endswith(".ipa")) | .browser_download_url' | head -1)
          
          if [ -z "$TAG_NAME" ] || [ "$TAG_NAME" = "null" ]; then
            echo "âŒ Error: Could not find release"
            exit 1
          fi
          
          if [ -z "$IPA_URL" ] || [ "$IPA_URL" = "null" ]; then
            echo "âŒ Error: No IPA found in release"
            exit 1
          fi
          
          echo "âœ… Found release: $TAG_NAME"
          echo "âœ… IPA URL: $IPA_URL"
          
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "published_at=$PUBLISHED_AT" >> $GITHUB_OUTPUT
          echo "ipa_url=$IPA_URL" >> $GITHUB_OUTPUT
          
      - name: Check if already deployed
        id: check
        run: |
          if [ "${{ github.event.inputs.force_deploy }}" = "true" ]; then
            echo "already_deployed=false" >> $GITHUB_OUTPUT
            echo "ðŸ”„ Force deploy requested"
            exit 0
          fi
          
          if [ -f "version.txt" ]; then
            CURRENT_VERSION=$(cat version.txt)
            if [ "$CURRENT_VERSION" = "${{ steps.release.outputs.tag_name }}" ]; then
              echo "already_deployed=true" >> $GITHUB_OUTPUT
              echo "âœ… Version $CURRENT_VERSION already deployed"
              exit 0
            fi
          fi
          echo "already_deployed=false" >> $GITHUB_OUTPUT
          echo "ðŸ”„ New version detected"
          
      - name: Download unsigned IPA
        if: steps.check.outputs.already_deployed != 'true'
        run: |
          echo "ðŸ“¥ Downloading IPA..."
          curl -L -H "Authorization: token ${{ github.token }}" \
            -o unsigned.ipa "${{ steps.release.outputs.ipa_url }}"
          
          FILE_SIZE=$(stat -f%z unsigned.ipa)
          echo "âœ… Downloaded: $FILE_SIZE bytes"
          
      - name: Install Zsign
        if: steps.check.outputs.already_deployed != 'true'
        run: |
          echo "ðŸ“¦ Installing Zsign..."
          brew install zsign
          zsign --version || echo "Zsign installed"
          
      - name: Setup certificate and provisioning profile
        if: steps.check.outputs.already_deployed != 'true'
        run: |
          echo "ðŸ” Setting up certificate and profile..."
          
          # Decode certificate
          echo "${{ secrets.P12_CERTIFICATE }}" | base64 --decode > certificate.p12
          
          # Decode provisioning profile
          echo "${{ secrets.PROVISIONING_PROFILE }}" | base64 --decode > profile.mobileprovision
          
          echo "âœ… Files decoded"
          ls -lh certificate.p12 profile.mobileprovision
          
      - name: Sign IPA with Zsign
        id: sign
        if: steps.check.outputs.already_deployed != 'true'
        run: |
          echo "âœï¸ Signing IPA with Zsign (Feather method)..."
          
          # Sign using zsign (same method as Feather)
          zsign -k certificate.p12 -p "${{ secrets.P12_PASSWORD }}" -m profile.mobileprovision \
            -o NoveoNative.ipa unsigned.ipa
          
          if [ ! -f NoveoNative.ipa ]; then
            echo "âŒ Signing failed"
            exit 1
          fi
          
          # Get file size
          SIZE=$(stat -f%z NoveoNative.ipa)
          SIZE_MB=$(echo "scale=2; $SIZE / 1024 / 1024" | bc)
          echo "âœ… Signed IPA: ${SIZE_MB}MB ($SIZE bytes)"
          echo "ipa_size=$SIZE" >> $GITHUB_OUTPUT
          
          # Extract Bundle ID
          unzip -q NoveoNative.ipa -d temp_extract
          APP_PATH=$(find temp_extract/Payload -name "*.app" -type d -depth 1 | head -1)
          
          if [ -n "$APP_PATH" ]; then
            BUNDLE_ID=$(defaults read "$APP_PATH/Info.plist" CFBundleIdentifier 2>/dev/null || echo "com.etisalat.INDY")
          else
            BUNDLE_ID="com.etisalat.INDY"
          fi
          
          rm -rf temp_extract
          
          echo "ðŸ“± Bundle ID: $BUNDLE_ID"
          echo "bundle_id=$BUNDLE_ID" >> $GITHUB_OUTPUT
          
          # Cleanup sensitive files
          rm -f certificate.p12 profile.mobileprovision unsigned.ipa
          
      - name: Update manifest.plist
        if: steps.check.outputs.already_deployed != 'true'
        run: |
          cat > manifest.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>items</key>
              <array>
                  <dict>
                      <key>assets</key>
                      <array>
                          <dict>
                              <key>kind</key>
                              <string>software-package</string>
                              <key>url</key>
                              <string>https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/NoveoNative.ipa</string>
                          </dict>
                      </array>
                      <key>metadata</key>
                      <dict>
                          <key>bundle-identifier</key>
                          <string>${{ steps.sign.outputs.bundle_id }}</string>
                          <key>bundle-version</key>
                          <string>${{ steps.release.outputs.tag_name }}</string>
                          <key>kind</key>
                          <string>software</string>
                          <key>title</key>
                          <string>NoveoNative</string>
                      </dict>
                  </dict>
              </array>
          </dict>
          </plist>
          EOF
          
          echo "ðŸ“„ Generated manifest.plist"
          cat manifest.plist
          
      - name: Update apps.json
        if: steps.check.outputs.already_deployed != 'true'
        run: |
          cat > apps.json << EOF
          {
            "name": "NoveoNative Repository",
            "identifier": "com.noveo.repo",
            "sourceURL": "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/apps.json",
            "apps": [
              {
                "name": "NoveoNative",
                "bundleIdentifier": "${{ steps.sign.outputs.bundle_id }}",
                "developerName": "PCPA",
                "subtitle": "Modern Messenger for iOS",
                "version": "${{ steps.release.outputs.tag_name }}",
                "versionDate": "${{ steps.release.outputs.published_at }}",
                "versionDescription": "Latest release",
                "downloadURL": "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/NoveoNative.ipa",
                "localizedDescription": "A beautiful and modern messaging app",
                "iconURL": "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/assets/icon512.png",
                "tintColor": "#3b82f6",
                "size": ${{ steps.sign.outputs.ipa_size || 50000000 }}
              }
            ]
          }
          EOF
          
      - name: Save version
        if: steps.check.outputs.already_deployed != 'true'
        run: echo "${{ steps.release.outputs.tag_name }}" > version.txt
          
      - name: Commit and push
        if: steps.check.outputs.already_deployed != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "ðŸš€ Deploy version ${{ steps.release.outputs.tag_name }} (Zsign)"
          git push origin gh-pages
          
      - name: Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.release.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Bundle ID:** ${{ steps.sign.outputs.bundle_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Signing Method:** Zsign (same as Feather)" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** âœ… Successfully deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“± Installation Links" >> $GITHUB_STEP_SUMMARY
          echo "- https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> $GITHUB_STEP_SUMMARY
