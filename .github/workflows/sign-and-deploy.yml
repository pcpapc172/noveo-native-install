name: Sign IPA and Deploy to GitHub Pages

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'Source repository (owner/repo)'
        required: true
        default: 'pcpapc172/NoveoNative'
      release_tag:
        description: 'Release tag (leave empty for latest)'
        required: false
  schedule:
    - cron: '0 */6 * * *'

jobs:
  sign-and-deploy:
    runs-on: macos-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          
      - name: Get latest release info
        id: release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          REPO="${{ github.event.inputs.source_repo || 'pcpapc172/NoveoNative' }}"
          echo "Fetching release from: $REPO"
          
          if [ -z "${{ github.event.inputs.release_tag }}" ]; then
            echo "Fetching latest release..."
            RELEASE_DATA=$(curl -s -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/repos/$REPO/releases/latest")
          else
            echo "Fetching specific release: ${{ github.event.inputs.release_tag }}"
            RELEASE_DATA=$(curl -s -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/repos/$REPO/releases/tags/${{ github.event.inputs.release_tag }}")
          fi
          
          # Debug: Show release data
          echo "Release data:"
          echo "$RELEASE_DATA" | jq '.'
          
          # Extract info with better error handling
          TAG_NAME=$(echo "$RELEASE_DATA" | jq -r '.tag_name // empty')
          PUBLISHED_AT=$(echo "$RELEASE_DATA" | jq -r '.published_at // empty')
          
          # Find IPA with better error handling
          IPA_URL=$(echo "$RELEASE_DATA" | jq -r '.assets[]? | select(.name | endswith(".ipa")) | .browser_download_url' | head -1)
          
          if [ -z "$TAG_NAME" ] || [ "$TAG_NAME" = "null" ]; then
            echo "âŒ Error: Could not find release"
            echo "Response: $RELEASE_DATA"
            exit 1
          fi
          
          if [ -z "$IPA_URL" ] || [ "$IPA_URL" = "null" ]; then
            echo "âŒ Error: No IPA found in release $TAG_NAME"
            echo "Available assets:"
            echo "$RELEASE_DATA" | jq -r '.assets[]?.name'
            exit 1
          fi
          
          echo "âœ… Found release: $TAG_NAME"
          echo "âœ… IPA URL: $IPA_URL"
          
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "published_at=$PUBLISHED_AT" >> $GITHUB_OUTPUT
          echo "ipa_url=$IPA_URL" >> $GITHUB_OUTPUT
          
      - name: Check if already deployed
        id: check
        run: |
          if [ -f "version.txt" ]; then
            CURRENT_VERSION=$(cat version.txt)
            if [ "$CURRENT_VERSION" = "${{ steps.release.outputs.tag_name }}" ]; then
              echo "already_deployed=true" >> $GITHUB_OUTPUT
              echo "âœ… Version $CURRENT_VERSION already deployed, skipping..."
              exit 0
            fi
          fi
          echo "already_deployed=false" >> $GITHUB_OUTPUT
          echo "ðŸ”„ New version detected, proceeding with deployment..."
          
      - name: Download unsigned IPA
        if: steps.check.outputs.already_deployed != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ðŸ“¥ Downloading IPA from: ${{ steps.release.outputs.ipa_url }}"
          curl -L -H "Authorization: token $GH_TOKEN" \
            -o unsigned.ipa "${{ steps.release.outputs.ipa_url }}"
          
          if [ ! -f unsigned.ipa ]; then
            echo "âŒ Failed to download IPA"
            exit 1
          fi
          
          FILE_SIZE=$(stat -f%z unsigned.ipa 2>/dev/null || stat -c%s unsigned.ipa 2>/dev/null)
          echo "âœ… Downloaded IPA: $FILE_SIZE bytes"
          ls -lh unsigned.ipa
          
      - name: Setup certificate and provisioning profile
        if: steps.check.outputs.already_deployed != 'true'
        run: |
          echo "ðŸ” Setting up certificate and provisioning profile..."
          
          # Decode certificate
          echo "${{ secrets.P12_CERTIFICATE }}" | base64 --decode > certificate.p12
          
          # Decode provisioning profile
          echo "${{ secrets.PROVISIONING_PROFILE }}" | base64 --decode > profile.mobileprovision
          
          # Create keychain
          security create-keychain -p actions temp.keychain
          security default-keychain -s temp.keychain
          security unlock-keychain -p actions temp.keychain
          security set-keychain-settings -t 3600 -u temp.keychain
          
          # Import certificate
          security import certificate.p12 -k temp.keychain -P "${{ secrets.P12_PASSWORD }}" -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple: -s -k actions temp.keychain
          
          # Copy provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          PROFILE_UUID=$(grep -a -A 1 'UUID' profile.mobileprovision | grep -o '<string>.*</string>' | sed 's/<[^>]*>//g')
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/${PROFILE_UUID}.mobileprovision
          
          echo "âœ… Certificate and profile installed"
          
      - name: Sign IPA
        id: sign
        if: steps.check.outputs.already_deployed != 'true'
        run: |
          echo "âœï¸ Signing IPA..."
          
          # Extract unsigned IPA
          unzip -q unsigned.ipa -d Payload
          
          # Find app bundle
          APP_PATH=$(find Payload -name "*.app" -maxdepth 2 | head -1)
          echo "App path: $APP_PATH"
          
          if [ -z "$APP_PATH" ]; then
            echo "âŒ Could not find .app bundle"
            exit 1
          fi
          
          # Get signing identity
          IDENTITY=$(security find-identity -v -p codesigning temp.keychain | grep "iPhone" | head -1 | grep -o '"[^"]*"' | tr -d '"')
          
          if [ -z "$IDENTITY" ]; then
            echo "âŒ Could not find signing identity"
            security find-identity -v -p codesigning temp.keychain
            exit 1
          fi
          
          echo "Signing identity: $IDENTITY"
          
          # Remove old signature
          rm -rf "$APP_PATH/_CodeSignature"
          
          # Sign frameworks and plugins
          find "$APP_PATH/Frameworks" -name "*.framework" -o -name "*.dylib" 2>/dev/null | while read framework; do
            echo "Signing: $framework"
            /usr/bin/codesign --force --sign "$IDENTITY" --timestamp=none "$framework"
          done
          
          # Sign the app
          /usr/bin/codesign --force --sign "$IDENTITY" \
            --timestamp=none \
            --generate-entitlement-der \
            "$APP_PATH"
          
          # Verify signature
          codesign -vvv --deep --strict "$APP_PATH"
          
          # Repackage IPA
          cd Payload
          zip -qr ../NoveoNative.ipa .
          cd ..
          
          # Get file size
          SIZE=$(stat -f%z NoveoNative.ipa 2>/dev/null || stat -c%s NoveoNative.ipa 2>/dev/null)
          echo "âœ… Signed IPA size: $SIZE bytes"
          echo "ipa_size=$SIZE" >> $GITHUB_OUTPUT
          
          # Cleanup
          rm -rf Payload unsigned.ipa certificate.p12 profile.mobileprovision
          security delete-keychain temp.keychain
          
      - name: Update manifest.plist
        if: steps.check.outputs.already_deployed != 'true'
        run: |
          cat > manifest.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>items</key>
              <array>
                  <dict>
                      <key>assets</key>
                      <array>
                          <dict>
                              <key>kind</key>
                              <string>software-package</string>
                              <key>url</key>
                              <string>https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/NoveoNative.ipa</string>
                          </dict>
                          <dict>
                              <key>kind</key>
                              <string>display-image</string>
                              <key>url</key>
                              <string>https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/assets/icon57.png</string>
                          </dict>
                          <dict>
                              <key>kind</key>
                              <string>full-size-image</string>
                              <key>url</key>
                              <string>https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/assets/icon512.png</string>
                          </dict>
                      </array>
                      <key>metadata</key>
                      <dict>
                          <key>bundle-identifier</key>
                          <string>com.yourcompany.noveonative</string>
                          <key>bundle-version</key>
                          <string>${{ steps.release.outputs.tag_name }}</string>
                          <key>kind</key>
                          <string>software</string>
                          <key>title</key>
                          <string>Noveo Native</string>
                      </dict>
                  </dict>
              </array>
          </dict>
          </plist>
          EOF
          
      - name: Update apps.json
        if: steps.check.outputs.already_deployed != 'true'
        run: |
          cat > apps.json << EOF
          {
            "name": "Noveo Native Repository",
            "identifier": "com.noveo.repo",
            "sourceURL": "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/apps.json",
            "apps": [
              {
                "name": "Noveo Native",
                "bundleIdentifier": "com.yourcompany.noveonative",
                "developerName": "Your Name",
                "subtitle": "Modern Messenger for iOS",
                "version": "${{ steps.release.outputs.tag_name }}",
                "versionDate": "${{ steps.release.outputs.published_at }}",
                "versionDescription": "Latest release with bug fixes and improvements",
                "downloadURL": "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/NoveoNative.ipa",
                "localizedDescription": "A beautiful and modern messaging app with real-time features including typing indicators, seen receipts, file sharing, and more.",
                "iconURL": "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/assets/icon512.png",
                "tintColor": "#3b82f6",
                "size": ${{ steps.sign.outputs.ipa_size || 50000000 }},
                "screenshotURLs": [
                  "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/assets/screenshot1.png",
                  "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/assets/screenshot2.png"
                ]
              }
            ],
            "news": [
              {
                "title": "Noveo Native ${{ steps.release.outputs.tag_name }} Released!",
                "identifier": "${{ steps.release.outputs.tag_name }}",
                "caption": "Check out the latest features and improvements",
                "date": "${{ steps.release.outputs.published_at }}",
                "tintColor": "#3b82f6",
                "imageURL": "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/assets/icon512.png",
                "notify": true
              }
            ]
          }
          EOF
          
      - name: Save version
        if: steps.check.outputs.already_deployed != 'true'
        run: |
          echo "${{ steps.release.outputs.tag_name }}" > version.txt
          
      - name: Commit and push
        if: steps.check.outputs.already_deployed != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "ðŸš€ Deploy version ${{ steps.release.outputs.tag_name }}"
          git push
          
      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.release.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Published:** ${{ steps.release.outputs.published_at }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ steps.check.outputs.already_deployed == 'true' && 'âœ… Already deployed' || 'âœ… Successfully deployed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“± Installation Links" >> $GITHUB_STEP_SUMMARY
          echo "- **Web Install:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> $GITHUB_STEP_SUMMARY
          echo "- **AltStore:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/apps.json" >> $GITHUB_STEP_SUMMARY
