<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Install NoveoNative - iOS</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="assets/icon512.png" alt="NoveoNative" class="logo" onerror="this.style.display='none'">
            <h1>NoveoNative</h1>
            <p class="tagline">Modern Messenger for iOS</p>
            <p class="version" id="version">Loading...</p>
        </div>

        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="size">-</div>
                <div class="stat-label">Size</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="updated">-</div>
                <div class="stat-label">Updated</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="method">OTA</div>
                <div class="stat-label">Method</div>
            </div>
        </div>

        <div class="install-section">
            <h2>üì≤ Installation Method</h2>
            
            <div class="method-card" id="otaCard">
                <div class="method-header">
                    <span class="method-icon">üì±</span>
                    <div>
                        <h3>Over-The-Air (OTA)</h3>
                        <p>Install directly on your device</p>
                    </div>
                </div>
                <a href="#" id="installBtn" class="install-btn">
                    Install Now
                </a>
                <div id="debugInfo" style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 8px; font-size: 12px; font-family: monospace; display: none;">
                    <strong>Debug Info:</strong><br>
                    <span id="debugText"></span>
                </div>
            </div>

            <div class="method-card">
                <div class="method-header">
                    <span class="method-icon">üîÑ</span>
                    <div>
                        <h3>AltStore / SideStore</h3>
                        <p>Add repository for auto-updates</p>
                    </div>
                </div>
                <div class="repo-url">
                    <input type="text" id="repoUrl" readonly>
                    <button onclick="copyRepoUrl()" class="copy-btn">Copy</button>
                </div>
            </div>

            <div class="method-card">
                <div class="method-header">
                    <span class="method-icon">üíæ</span>
                    <div>
                        <h3>Direct Download</h3>
                        <p>Download IPA for manual install</p>
                    </div>
                </div>
                <a href="NoveoNative.ipa" class="download-btn" download>
                    Download IPA
                </a>
            </div>

            <div class="method-card">
                <div class="method-header">
                    <span class="method-icon">üîç</span>
                    <div>
                        <h3>Debug Links</h3>
                        <p>Check configuration files</p>
                    </div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <a href="manifest.plist" target="_blank" style="padding: 8px; background: #e9ecef; border-radius: 6px; text-decoration: none; color: #333; font-size: 14px;">
                        üìÑ View manifest.plist
                    </a>
                    <a href="apps.json" target="_blank" style="padding: 8px; background: #e9ecef; border-radius: 6px; text-decoration: none; color: #333; font-size: 14px;">
                        üìÑ View apps.json
                    </a>
                    <a href="version.txt" target="_blank" style="padding: 8px; background: #e9ecef; border-radius: 6px; text-decoration: none; color: #333; font-size: 14px;">
                        üìÑ View version.txt
                    </a>
                </div>
            </div>
        </div>

        <div class="instructions">
            <h3>üìã Installation Steps (OTA):</h3>
            <ol>
                <li>Tap <strong>"Install Now"</strong> button</li>
                <li>Allow the download to start</li>
                <li>Go to <strong>Settings ‚Üí General ‚Üí VPN & Device Management</strong></li>
                <li>Find the app and tap <strong>"Trust"</strong></li>
                <li>Return home and launch the app</li>
            </ol>
            <p style="margin-top: 10px; color: #d32f2f;"><strong>‚ö†Ô∏è If installation fails:</strong></p>
            <ul style="margin-top: 5px;">
                <li>Make sure you're using iOS 9.0 or later</li>
                <li>Check that your device has enough storage</li>
                <li>Try downloading via Direct Download instead</li>
                <li>Your device may need to be registered in the provisioning profile</li>
            </ul>
        </div>

        <div class="warning">
            <strong>‚ö†Ô∏è Important Notice:</strong><br>
            This app is distributed outside the App Store and signed with an enterprise certificate.
            Only install if you trust the developer. Your device may require you to trust the certificate in Settings.
        </div>

        <div class="footer">
            <p>Noveo</p>
            <p class="github-link">
                <a href="https://github.com/pcpapc172/NoveoNative" target="_blank">
                    View Source Code on GitHub
                </a>
            </p>
        </div>
    </div>

    <script>
        const GITHUB_PAGES_URL = window.location.origin + window.location.pathname.replace(/\/$/, '');
        const VERSION_FILE = GITHUB_PAGES_URL + '/version.txt';
        
        // Enhanced logging
        function log(msg) {
            console.log('[NoveoNative]', msg);
            const debugInfo = document.getElementById('debugInfo');
            const debugText = document.getElementById('debugText');
            if (debugInfo && debugText) {
                debugInfo.style.display = 'block';
                debugText.innerHTML += msg + '<br>';
            }
        }
        
        log('Page loaded');
        log('Base URL: ' + GITHUB_PAGES_URL);
        
        document.getElementById('repoUrl').value = GITHUB_PAGES_URL + '/apps.json';
        
        const manifestUrl = GITHUB_PAGES_URL + '/manifest.plist';
        const installUrl = `itms-services://?action=download-manifest&url=${encodeURIComponent(manifestUrl)}`;
        
        log('Manifest URL: ' + manifestUrl);
        log('Install URL: ' + installUrl);
        
        document.getElementById('installBtn').href = installUrl;
        
        // Check if files exist
        async function checkFile(url, name) {
            try {
                const response = await fetch(url, { method: 'HEAD' });
                if (response.ok) {
                    log(`‚úÖ ${name} exists (${response.status})`);
                    return true;
                } else {
                    log(`‚ùå ${name} not found (${response.status})`);
                    return false;
                }
            } catch (error) {
                log(`‚ùå ${name} error: ${error.message}`);
                return false;
            }
        }
        
        async function validateSetup() {
            log('Validating setup...');
            await checkFile(GITHUB_PAGES_URL + '/manifest.plist', 'manifest.plist');
            await checkFile(GITHUB_PAGES_URL + '/NoveoNative.ipa', 'NoveoNative.ipa');
            await checkFile(GITHUB_PAGES_URL + '/apps.json', 'apps.json');
            await checkFile(GITHUB_PAGES_URL + '/version.txt', 'version.txt');
        }
        
        async function loadVersion() {
            try {
                const response = await fetch(VERSION_FILE + '?t=' + Date.now());
                const version = await response.text();
                document.getElementById('version').textContent = `Version ${version.trim()}`;
                log('Version: ' + version.trim());
            } catch (error) {
                document.getElementById('version').textContent = 'Version 1.0.0';
                log('Version fetch error: ' + error.message);
            }
        }
        
        async function getIPASize() {
            try {
                const response = await fetch(GITHUB_PAGES_URL + '/NoveoNative.ipa', { method: 'HEAD' });
                const size = parseInt(response.headers.get('content-length'));
                const sizeMB = (size / 1024 / 1024).toFixed(1);
                document.getElementById('size').textContent = `${sizeMB} MB`;
                log('IPA size: ' + sizeMB + ' MB');
            } catch (error) {
                document.getElementById('size').textContent = 'N/A';
                log('Size fetch error: ' + error.message);
            }
        }
        
        function copyRepoUrl() {
            const input = document.getElementById('repoUrl');
            input.select();
            document.execCommand('copy');
            
            const btn = event.target;
            btn.textContent = '‚úì Copied!';
            setTimeout(() => {
                btn.textContent = 'Copy';
            }, 2000);
        }
        
        // Better iOS/iPadOS detection
        function isIOSDevice() {
            if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                return true;
            }
            if (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1) {
                return true;
            }
            if (navigator.platform === 'iPad' || navigator.platform === 'iPhone') {
                return true;
            }
            return false;
        }

        
        
        const isIOS = isIOSDevice();
        log('Is iOS device: ' + isIOS);
        log('User Agent: ' + navigator.userAgent);
        log('Platform: ' + navigator.platform);
        log('Max touch points: ' + navigator.maxTouchPoints);



        async function getLastModified() {
            try {
                // Fetch headers for the IPA file
                const response = await fetch(GITHUB_PAGES_URL + '/NoveoNative.ipa', { method: 'HEAD' });
                
                // Get the Last-Modified date string
                const lastMod = response.headers.get('last-modified');
                
                if (lastMod) {
                    const date = new Date(lastMod);
                    
                    // Option A: Simple Date (e.g., "12/6/2025")
                    // document.getElementById('updated').textContent = date.toLocaleDateString();
                    
                    // Option B: Relative Time (e.g., "2 hours ago") - RECOMMENDED
                    document.getElementById('updated').textContent = timeAgo(date);
                    
                    log('Updated date: ' + date.toISOString());
                }
            } catch (error) {
                log('Date fetch error: ' + error.message);
            }
        }
        
        // Helper function to make "2 hours ago" style text
        function timeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
        
            if (interval > 1) return Math.floor(interval) + " years ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " mins ago";
            return "Just now";
        }

        // Track install button clicks
        document.getElementById('installBtn').addEventListener('click', function(e) {
            log('Install button clicked');
            log('Redirecting to: ' + installUrl);
            // Don't prevent default - let it navigate
        });
        
        validateSetup();
        loadVersion();
        getIPASize();
        getLastModified();
    </script>
</body>
</html>
